# Requirements Archive: v1.0 Profile Environment Variables

**Archived:** 2026-02-14
**Status:** ✅ SHIPPED

This is the archived requirements specification for v1.0.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

# Requirements: Profile Environment Variables Feature

**Version:** v1.0
**Milestone:** 4 phases (Config Model → Session Launch → Documentation → Testing)
**Status:** ✅ COMPLETE

---

## Overview

Enable per-profile environment variable configuration in Agent of Empires, allowing different profiles to provide different environment variables to coding agent sessions (both sandboxed and non-sandboxed).

---

## Functional Requirements

### FR-1: Profile Environment Fields in Data Model
Profile configuration must support defining environment variables in two ways:

**FR-1.1:** `environment` field (array of strings)
- Purpose: Forward environment variables from host environment into session
- Format: `["VAR_NAME", "ANOTHER_VAR"]`
- Behavior: For each key in array, read value from host environment and inject into session
- Scope: Applies to both sandbox and non-sandbox modes

**FR-1.2:** `environment_values` field (map of string to string)
- Purpose: Define explicit environment variable values in config
- Format: `{ "VAR_NAME" = "value", "ANOTHER_VAR" = "another value" }`
- Behavior: Use literal values (with `$VAR` expansion support)
- Scope: Applies to both sandbox and non-sandbox modes

**FR-1.3:** Variable expansion in `environment_values`
- Support `$VAR` syntax to reference host environment variables
- Example: `PROJECT_DIR = "$HOME/work/project"` resolves to home-expanded path
- Support `$$` escape for literal `$` (e.g., `$$HOME` becomes `$HOME`)
- Return `None` for undefined environment variables (not fail)

**Acceptance Criteria:**
- [x] ProfileConfig struct has `environment: Option<Vec<String>>` field
- [x] ProfileConfig struct has `environment_values: Option<HashMap<String, String>>` field
- [x] TOML serialization/deserialization works correctly for both fields
- [x] Default behavior is `None` (inherit from global)

### FR-2: Shared Environment Variable Resolution
Extract environment variable resolution logic into shared utility function.

**FR-2.1:** `resolve_env_value()` function
- Input: `&str` (value to resolve)
- Output: `Option<String>` (resolved value or None if undefined)
- Behavior:
  - If starts with `$$`, return literal `$` + rest
  - If starts with `$`, read from host environment
  - Otherwise, return literal value

**FR-2.2:** `resolve_env_vars()` function
- Input: `&[String]` (environment keys) and `&HashMap<String, String>` (explicit values)
- Output: `HashMap<String, String>` (merged resolved values)
- Behavior:
  - Collect values from environment keys by reading host environment
  - Collect and resolve values from explicit values map
  - Explicit values override environment keys on name conflicts
  - Skip undefined environment variables (don't error)

**Acceptance Criteria:**
- [x] `resolve_env_value()` is in `src/session/config.rs` with correct signature
- [x] `resolve_env_value()` correctly handles `$$` escapes
- [x] `resolve_env_value()` correctly expands `$VAR` from host
- [x] `resolve_env_value()` returns literal values unchanged
- [x] `resolve_env_value()` returns `None` for undefined environment variables
- [x] `resolve_env_vars()` merges environment keys and explicit values correctly
- [x] Explicit values override environment keys on name conflicts

### FR-3: Profile Environment Variable Merging
Profile environment variables must merge with sandbox environment variables with proper precedence.

**FR-3.1:** `merge_env_vars_with_profile()` function
- Input: `Vec<(String, String)>` (sandbox env vars) and `&ProfileConfig`
- Output: `Vec<(String, String)>` (merged env vars with profile precedence)
- Behavior:
  - Start with sandbox environment variables
  - Add profile environment variables (both `environment` keys and `environment_values`)
  - Profile variables override sandbox variables on name conflicts

**FR-3.2:** Update `collect_env_keys()` to accept profile_config
- Input: Add `Option<&ProfileConfig>` parameter
- Behavior: Add keys from `profile.environment` to collection
- Precedence: Profile keys override sandbox keys on duplicates

**FR-3.3:** Update `collect_env_values()` to accept profile_config
- Input: Add `Option<&ProfileConfig>` parameter
- Behavior: Add resolved values from `profile.environment_values` to collection
- Precedence: Profile values override sandbox values on duplicates

**Acceptance Criteria:**
- [x] `merge_env_vars_with_profile()` exists with correct signature
- [x] `merge_env_vars_with_profile()` respects profile precedence
- [x] `collect_env_keys()` accepts and uses `Option<&ProfileConfig>` parameter
- [x] `collect_env_values()` accepts and uses `Option<&ProfileConfig>` parameter
- [x] Profile env vars are correctly merged with sandbox env vars
- [x] Profile env vars override sandbox env vars on name conflicts

### FR-4: Session Launch Integration
Profile environment variables must be applied when launching sessions.

**FR-4.1:** Non-sandbox session launch
- Resolve profile environment variables using `resolve_env_vars()`
- Pass resolved env vars to tmux session creation
- Verify env vars are available in session process

**FR-4.2:** Paired terminal launch
- Use same profile env vars as parent session
- Pass to tmux terminal creation

**FR-4.3:** Docker exec commands (sandbox mode)
- Merge profile env vars with sandbox env vars
- Apply merged env vars to `docker exec` commands

**FR-4.4:** Docker container creation (sandbox mode)
- Container config uses profile_config parameter
- Profile env vars included in container environment

**Acceptance Criteria:**
- [x] Non-sandbox sessions receive profile env vars
- [x] Paired terminals receive same env vars as parent session
- [x] Docker exec commands receive merged profile + sandbox env vars
- [x] Docker container creation includes profile env vars
- [x] Profile env vars are available in all session contexts

### FR-5: TUI Settings Support
TUI settings must allow editing profile environment fields.

**FR-5.1:** FieldKey entries for environment fields
- `FieldKey::ProfileEnvironment` for `environment` array
- `FieldKey::ProfileEnvironmentValues` for `environment_values` map

**FR-5.2:** SettingField definitions
- List editor for `environment` field (add/remove items)
- Key-value editor for `environment_values` field

**FR-5.3:** Input handling
- `apply_field_to_profile()` handles new fields
- `clear_profile_override()` handles new fields

**Acceptance Criteria:**
- [x] TUI can edit `environment` field in profiles
- [x] TUI can edit `environment_values` field in profiles
- [x] FieldKey variants exist for both fields
- [x] SettingField entries exist for both fields
- [x] Apply and clear functions handle new fields

### FR-6: Documentation
User documentation must describe the feature comprehensively.

**FR-6.1:** Profile Environment Variables section
- Location: After Profiles section in configuration.md
- Subsections: environment vs environment_values, merge behavior, precedence

**FR-6.2:** Use case examples
- Minimum 3 concrete use cases
- Show TOML configuration
- Show bash command usage or result

**FR-6.3:** Precedence rules documentation
- Profile > sandbox on conflicts
- Clear explanation of merge behavior

**Acceptance Criteria:**
- [x] Documentation section exists in configuration.md
- [x] environment and environment_values are explained
- [x] Precedence rules are documented
- [x] At least 3 use cases with examples
- [x] Documentation builds successfully

---

## Non-Functional Requirements

### NFR-1: Performance
- [x] Environment variable resolution must complete in <10ms for typical configs (<50 vars)
- [x] Configuration loading with env var resolution must not block UI

### NFR-2: Backward Compatibility
- [x] Existing configs without profile env vars must work unchanged
- [x] Default behavior must be to inherit from global config

### NFR-3: Test Coverage
- [x] Minimum 80% code coverage for new code
- [x] Unit tests for all public functions
- [x] Integration tests for session launch scenarios

### NFR-4: Error Handling
- [x] Undefined environment variables in `$VAR` expansion must return None (not crash)
- [x] Invalid TOML must produce clear error messages

---

## Out of Scope

The following are explicitly NOT part of this requirement:

- OS-1: Environment variable validation beyond format checking
- OS-2: Environment variable encryption or secure storage
- OS-3: Dynamic environment variable loading (requires config reload)
- OS-4: Complex templating (beyond simple `$VAR` expansion)
- OS-5: Shell aliases or functions in profiles
- OS-6: Per-session environment variable overrides

---

## Traceability Matrix

| Req ID | Phase(s) | Status |
|---------|-----------|--------|
| FR-1.1 | 1 | ✓ Complete |
| FR-1.2 | 1 | ✓ Complete |
| FR-1.3 | 1 | ✓ Complete |
| FR-2.1 | 1 | ✓ Complete |
| FR-2.2 | 1 | ✓ Complete |
| FR-3.1 | 2 | ✓ Complete |
| FR-3.2 | 2 | ✓ Complete |
| FR-3.3 | 2 | ✓ Complete |
| FR-4.1 | 2 | ✓ Complete |
| FR-4.2 | 2 | ✓ Complete |
| FR-4.3 | 2 | ✓ Complete |
| FR-4.4 | 2 | ✓ Complete |
| FR-5.1 | 1 | ✓ Complete |
| FR-5.2 | 1 | ✓ Complete |
| FR-5.3 | 1 | ✓ Complete |
| FR-6.1 | 3 | ✓ Complete |
| FR-6.2 | 3 | ✓ Complete |
| FR-6.3 | 3 | ✓ Complete |
| NFR-1 | 4 | ✓ Complete |
| NFR-2 | 1-3 | ✓ Complete |
| NFR-3 | 4 | ✓ Complete |
| NFR-4 | 1-2 | ✓ Complete |

---

## Milestone Summary

**Shipped:** 22 of 22 requirements (100%)
**Adjusted:** None - all requirements delivered as specified
**Dropped:** None

---

*Archived: 2026-02-14 as part of v1.0 milestone completion*
