# Milestone v1.0: Profile Environment Variables

**Status:** ✅ SHIPPED 2026-02-14
**Phases:** 1-4
**Total Plans:** 6

## Overview

A feature set that enables per-profile environment variable configuration in Agent of Empires. Profiles can define environment variables that apply to both sandboxed and non-sandboxed coding agent sessions, with automatic precedence resolution when conflicts occur between global sandbox and profile-specific values.

## Phases

### Phase 1: Config Data Model & Shared Resolution

**Goal**: Implement profile environment variable configuration and shared resolution utilities.
**Depends on**: None
**Plans**: 1 plan

Plans:

- [x] 01-01: Profile environment fields in config data model

**Details:**

- Added `environment` (list of env var names to resolve from shell) to ProfileConfig
- Added `environment_values` (map of env var name → value) to ProfileConfig
- Created shared `resolve_env_vars()` utility in src/session/config.rs
- Placed fields as top-level in ProfileConfig (apply to both sandbox and non-sandbox modes)

---

### Phase 2: Session Launch & TUI Settings

**Goal**: Integrate profile environment variables into session launch and Docker container creation.
**Depends on**: Phase 1
**Plans**: 3 plans

Plans:

- [x] 02-01: Add env var support to tmux session creation
- [x] 02-02: Merge profile env vars with Docker container environment
- [x] 02-03: Container creation env vars gap closure

**Details:**

- Added env_vars parameter to tmux session creation
- Integrated profile env vars into Docker exec commands
- Added `merge_env_vars_with_profile()` helper for clean merging logic
- Profile env vars override sandbox env vars on name conflicts (profile wins)
- Container creation already used profile_config correctly (no changes needed)

---

### Phase 3: Documentation

**Goal**: Update documentation with profile environment variable features and create usage guides.
**Depends on**: Phase 2
**Plans**: 1 plan

Plans:

- [x] 03-01: Document profile environment variables in configuration.md

**Details:**

- Added comprehensive Profile Environment Variables section to docs/guides/configuration.md
- Documented `environment` vs `environment_values` fields with table format
- Explained merge behavior and precedence rules (profile > sandbox on conflicts)
- Provided three concrete use cases with TOML and bash examples:
  1. API keys per client
  2. Tool version management
  3. Project-specific configuration

---

### Phase 4: Testing

**Goal**: Fix compilation bugs and achieve 80%+ test coverage for all profile environment variable functionality.
**Depends on**: Phase 3
**Plans**: 1 plan

Plans:

- [x] 04-01: Comprehensive testing and bug fixes

**Details:**

- Fixed 6 compilation errors in src/session/instance.rs
- Fixed 4 test function calls in src/tmux/session.rs
- Added 27 unit tests:
  - 10 tests for resolve_env_value() and resolve_env_vars() (100% coverage)
  - 9 tests for collect_env_keys() and collect_env_values() (90%+ coverage)
  - 8 tests for merge_env_vars_with_profile() (100% coverage)
- Added 5 integration tests in tests/profile_env_vars.rs
- All quality checks passed (cargo fmt, cargo clippy)

---

## Milestone Summary

**Key Decisions:**

| Decision | Rationale | Outcome |
|----------|-----------|---------|
| Place `environment` and `environment_values` as top-level fields in ProfileConfig | These fields apply to both sandbox AND non-sandbox modes, not just sandbox | ✓ Implemented |
| Profile env vars merge INTO global.sandbox.environment_* | Maintains consistency with existing config pattern and ensures profile env vars are available in both modes | ✓ Implemented |
| Profile precedence on name conflicts | User should have final control over env var values in their profile | ✓ Implemented |
| Extract `resolve_env_vars()` to src/session/config.rs | Shared utility needed by multiple modules; config module is appropriate location | ✓ Implemented |
| `Option<&ProfileConfig>` parameter pattern | Avoids cloning large ProfileConfig structs while allowing None for "no profile" case | ✓ Implemented |
| Skip container creation merge refactoring | Implementation already working; would require significant Rust ownership/refactoring for no functional benefit | ✓ Verified |

**Issues Resolved:**

- Fixed 6 compilation errors from Phase 2 implementation (profile_config.as_deref() calls, missing arguments, ownership issues)
- Fixed 4 test function calls missing env_vars argument
- Resolved TOML parsing issues in integration tests

**Technical Debt Incurred:**

- Container creation `build_container_config()` uses profile_config parameter directly without refactoring to use `merge_env_vars_with_profile()` helper. Works correctly but could be more consistent.

---

*For current project status, see .planning/PROJECT.md*
