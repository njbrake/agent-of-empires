---
phase: 03-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [docs/guides/configuration.md]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can find documentation for profile environment variables"
    - "User understands how profile environment and environment_values work"
    - "User knows how profile env vars merge with sandbox env vars"
    - "User knows precedence rules (profile wins on conflicts)"
    - "User knows profile env vars apply to both sandbox and non-sandbox modes"
    - "User has concrete examples of use cases"
    - "Documentation builds successfully without errors"
  artifacts:
    - path: "docs/guides/configuration.md"
      provides: "Complete documentation including profile environment variables"
      min_lines: 230  # Current 191 + ~40 lines for new content
      contains: "## Profile Environment Variables"
      contains: "| `environment` |"
      contains: "| `environment_values` |"
  key_links:
    - from: "docs/guides/configuration.md (Profiles section, line 170)"
      to: "new Profile Environment Variables subsection"
      via: "Markdown subsection added after profile examples"
      pattern: "## Profile Environment Variables"
    - from: "Profile Environment Variables subsection"
      to: "docs/guides/sandbox.md (environment section, line 111)"
      via: "Pattern consistency (environment vs environment_values)"
      pattern: "### environment vs environment_values"
---

<objective>
Document the new profile environment variables feature (environment and environment_values fields) that were added in Phase 1 and integrated in Phase 2.

Purpose: Users need to understand how profile-level environment variables work, how they merge with sandbox environment variables, and how to use them for common scenarios like different API keys per client or project-specific configurations.

Output: Updated docs/guides/configuration.md with Profile Environment Variables section, including option tables, merge behavior explanation, precedence rules, and concrete use case examples.
</objective>

<execution_context>
@/home/mcrowe/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/mcrowe/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-documentation/03-RESEARCH.md

# Implementation details from Phase 1 and 2
@src/session/profile_config.rs  # ProfileConfig structure (environment, environment_values fields)
@src/session/instance.rs  # merge_env_vars_with_profile() function (lines 120-143)
@src/session/config.rs  # resolve_env_vars() function
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Profile Environment Variables subsection to configuration.md</name>
  <files>docs/guides/configuration.md</files>
  <action>
  Add a new subsection "## Profile Environment Variables" after the existing Profiles section (after line 182, before "## Repo Config").

  Include the following content following the established pattern from the Sandbox environment section (lines 111-114 and 97-109):

  ### environment vs environment_values
  - Explain that both `environment` and `environment_values` fields work identically to their sandbox counterparts
  - Note that profile env vars apply to BOTH sandbox and non-sandbox modes (important difference from sandbox-only env vars)
  - Document that values starting with `$` reference a host env var (e.g., `"$AOE_GH_TOKEN"` reads from host)
  - Note that `$$` is used for a literal `$`

  ### Table of Options

  | Option | Default | Description |
  |--------|---------|-------------|
  | `environment` | (inherited from sandbox) | Host env var names to pass through. Adds to sandbox environment, overrides on conflicts. |
  | `environment_values` | (inherited from sandbox) | Env vars with explicit values. Adds to sandbox values, overrides on conflicts. |

  ### Merge Behavior and Precedence

  Add a subsection explaining how profile env vars merge with sandbox env vars:
  - Profile environment and environment_values MERGE with sandbox environment and environment_values (they don't replace them)
  - On name conflicts, profile values WIN (profile > sandbox)
  - This allows global defaults in sandbox config with per-profile overrides
  - Example: Global has `ANTHROPIC_API_KEY`, profile can override with a different key or add project-specific vars

  ### TOML Configuration Example

  Add example showing profile config with environment variables:

  ```toml
  # ~/.agent-of-empires/profiles/client-a/config.toml
  environment = ["CLIENT_DB_URL"]
  environment_values = { ANTHROPIC_API_KEY = "$CLIENT_A_KEY" }
  ```

  Follow these formatting rules:
  - Use proper Markdown heading levels (## for main section, ### for subsections)
  - Use TOML syntax highlighting (```toml) for code blocks
  - Match table format exactly (3 columns: Option, Default, Description)
  - No trailing spaces
  - Consistent indentation with surrounding sections
  </action>
  <verify>
  1. Read docs/guides/configuration.md and verify new section exists between "Profiles" and "Repo Config"
  2. Run `grep -n "## Profile Environment Variables" docs/guides/configuration.md` to confirm heading exists
  3. Run `grep -n "| \`environment\` |" docs/guides/configuration.md` to confirm table entry
  4. Run `grep -n "| \`environment_values\` |" docs/guides/configuration.md` to confirm table entry
  5. Run `grep -n "profile wins" docs/guides/configuration.md` (case-insensitive) to confirm precedence documented
  </verify>
  <done>
  Profile Environment Variables subsection exists in docs/guides/configuration.md with:
  - Environment vs environment_values explanation
  - Table of options (environment, environment_values with defaults and descriptions)
  - Merge behavior and precedence rules documented (profile > sandbox on conflicts)
  - TOML configuration example
  - Proper Markdown formatting and syntax highlighting
  </done>
</task>

<task type="auto">
  <name>Task 2: Add use case examples for profile environment variables</name>
  <files>docs/guides/configuration.md</files>
  <action>
  Add a "### Use Cases" subsection at the end of the Profile Environment Variables section (after the TOML example, before "## Repo Config").

  Include 3 concrete use cases following the pattern from docs/guides/sandbox.md (lines 125-149):

  ### Use Case 1: Different API keys per client

  For a consulting project, use profile environment variables to avoid exposing client secrets:

  ```toml
  # ~/.agent-of-empires/profiles/client-a/config.toml
  environment_values = { ANTHROPIC_API_KEY = "$CLIENT_A_KEY" }
  ```

  ```bash
  export CLIENT_A_KEY="sk-ant-..."
  aoe -p client-a
  ```

  ### Use Case 2: Project-specific database URLs

  Different projects can have different database connections configured via profiles:

  ```toml
  # ~/.agent-of-empires/profiles/project-alpha/config.toml
  environment = ["ALPHA_DB_URL"]
  environment_values = { NODE_ENV = "production" }
  ```

  ```bash
  export ALPHA_DB_URL="postgresql://user:pass@alpha-db.example.com/db"
  aoe -p project-alpha
  ```

  ### Use Case 3: Different tool versions per environment

  Use profile environment variables to switch between development and production tooling:

  ```toml
  # ~/.agent-of-empires/profiles/prod/config.toml
  environment_values = { NODE_ENV = "production", USE_STAGING_API = "false" }
  ```

  ```toml
  # ~/.agent-of-empires/profiles/dev/config.toml
  environment_values = { NODE_ENV = "development", USE_STAGING_API = "true" }
  ```

  Follow these formatting rules:
  - Each use case has a clear heading (Use Case 1, Use Case 2, etc.)
  - Brief description of when to use this pattern
  - TOML code block with syntax highlighting (```toml)
  - Bash example showing how to set the host environment variable
  - No trailing spaces
  - Consistent with existing use case format in sandbox.md
  </action>
  <verify>
  1. Run `grep -n "### Use Case" docs/guides/configuration.md` to confirm use cases exist
  2. Run `grep -n "Different API keys per client" docs/guides/configuration.md` to confirm first use case
  3. Run `grep -n "Project-specific database URLs" docs/guides/configuration.md` to confirm second use case
  4. Run `grep -n "Different tool versions per environment" docs/guides/configuration.md` to confirm third use case
  5. Count ```toml blocks in the section (should have 4: 1 general example + 3 use cases)
  </verify>
  <done>
  Three use case examples added to Profile Environment Variables section:
  - Use Case 1: Different API keys per client
  - Use Case 2: Project-specific database URLs
  - Use Case 3: Different tool versions per environment
  Each use case includes:
  - Clear description of the scenario
  - TOML configuration example
  - Bash command example
  - Proper syntax highlighting
  </done>
</task>

<task type="auto">
  <name>Task 3: Build and verify documentation</name>
  <files>docs/</files>
  <action>
  Build the documentation site to verify that there are no syntax errors or formatting issues:

  1. Navigate to the project root
  2. Run `mdbook build` to build the documentation
  3. Check that the build completes successfully without errors or warnings
  4. Verify that the generated `book/index.html` exists
  5. Open the built documentation in a browser (optional but recommended) to visually verify the new content renders correctly

  If there are any build errors:
  - Identify the specific error message
  - Fix the markdown syntax issue (usually unclosed code blocks, malformed tables, or incorrect heading levels)
  - Re-run the build until it succeeds
  </action>
  <verify>
  1. Run `mdbook build` and capture the output
  2. Verify command exits with code 0 (success)
  3. Run `test -f book/index.html` to confirm output file exists
  4. Run `test -f book/guides/configuration.html` to confirm configuration page built
  5. Run `grep -q "Profile Environment Variables" book/guides/configuration.html` to verify content is in output
  </verify>
  <done>
  Documentation builds successfully:
  - `mdbook build` completes without errors
  - book/index.html and book/guides/configuration.html are generated
  - "Profile Environment Variables" section appears in the built HTML
  - All tables and code blocks render correctly
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. Content completeness: docs/guides/configuration.md has Profile Environment Variables section with all required subsections
2. Accuracy: Documentation matches actual implementation in src/session/instance.rs (merge_env_vars_with_profile function)
3. Formatting: All code blocks have proper language identifiers (```toml, ```bash)
4. Consistency: Table format matches existing sections, use cases match sandbox.md patterns
5. Build: mdbook build completes successfully without errors or warnings
6. Testing: Built documentation renders correctly in browser (optional but recommended)
</verification>

<success_criteria>
Phase 3 is complete when:
- Profile Environment Variables section added to docs/guides/configuration.md
- Environment and environment_values fields documented with table format
- Merge behavior and precedence rules clearly explained
- Three use case examples provided with TOML and bash commands
- Documentation builds successfully without errors
- Content follows existing patterns from sandbox.md
</success_criteria>

<output>
After completion, create `.planning/phases/03-documentation/03-01-SUMMARY.md` with:
- Documentation files modified
- Sections added (Profile Environment Variables, Use Cases)
- Number of examples provided
- Any decisions about documentation structure
- Build verification results
</output>
